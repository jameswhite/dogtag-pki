#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export DH_OPTIONS

VER :=  $(shell dpkg-parsechangelog | sed -n 's/^Version: *\(.*\)-.*$$/\1/ p' | sed -e 's/~.*//')

JAVA_HOME=/usr/lib/jvm/default-java
CFLAGS += -I/usr/include/nss
CXXFLAGS += -I/usr/include/nss
DEB_BUILD_DIR ?= $(CURDIR)/build

CONFIGS = core \
	  dogtag-pki-theme

STAMP_DIR = debian/stamp
STAMP = $(STAMP_DIR)/$(DEB_BUILD_GNU_TYPE)
BUILD_STAMPS = $(addprefix $(STAMP)-build-, $(CONFIGS))

confflags-common = 

confflags-core = \
	-DBUILD_PKI_CORE:BOOL=ON \
	-DSERVLET_JAR=/usr/share/java/servlet-api.jar \
	-DXERCES_JAR=/usr/share/java/xercesImpl.jar \
	-DXALAN_JAR=/usr/share/java/xalan2.jar \
	$(confflags-common)

confflags-dogtag-pki-theme = \
	-DBUILD_DOGTAG_PKI_THEME:BOOL=ON \
	$(confflags-common)

override_dh_auto_clean:
	rm -rf $(CURDIR)/build

override_dh_auto_configure:

build-stamp: $(BUILD_STAMPS)
	>$@

$(STAMP)-build-%:
	mkdir -p $(DEB_BUILD_DIR)/$*
	cd $(DEB_BUILD_DIR)/$* && \
	cmake -DCMAKE_INSTALL_PREFIX=/usr \
		-DSYSCONF_INSTALL_DIR:PATH=/etc \
		-DVAR_INSTALL_DIR:PATH=/var \
		-DJAVA_LIB_INSTALL_DIR=/usr/share/java \
		$(confflags-$*) \
		../../pki
	cd $(DEB_BUILD_DIR)/$* && make VERBOSE=1

override_dh_auto_build: build-stamp

override_dh_auto_install:
	set -e; for config in $(CONFIGS); do \
		make -C $(DEB_BUILD_DIR)/$$config DESTDIR=$(CURDIR)/debian/tmp install; \
	done

	mkdir -p $(CURDIR)/debian/libpki-symkey-java/usr/lib/jni
	install -m 0755 $(DEB_BUILD_DIR)/core/base/symkey/src/com/netscape/symkey/libsymkey.so \
		$(CURDIR)/debian/libpki-symkey-java/usr/lib/jni/

override_jh_installlibs:
	jh_installlibs --no-mangle -plibpki-symkey-java \
		$(DEB_BUILD_DIR)/core/base/symkey/src/symkey.jar

override_jh_installjavadoc:
	jh_installjavadoc -plibpki-common-java-doc \
		$(DEB_BUILD_DIR)/core/base/common/src/javadoc/pki-common-*
	jh_installjavadoc -plibpki-java-tools-java-doc \
		$(DEB_BUILD_DIR)/core/base/java-tools/src/javadoc/pki-java-tools-*
	jh_installjavadoc -plibpki-util-java-doc \
		$(DEB_BUILD_DIR)/core/base/util/src/javadoc/pki-util-*

%:
	dh $@ --with javahelper --builddirectory=build/
